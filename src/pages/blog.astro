---
// src/pages/blog.astro - Blog listing page
import { getCollection } from 'astro:content';
import Base from "@/layouts/Base.astro";
import Posts from "@/layouts/components/Posts.astro";
import Pagination from "@/layouts/components/Pagination.astro";

// Helper for readTime calculation (same as index.astro)
function calculateReadTime(content, wordsPerMinute = 130) {
  if (!content) return 10;
  const plainText = content
    .replace(/---[\s\S]*?---/, '')
    .replace(/```[\s\S]*?```/g, '')
    .replace(/<[^>]*>/g, '')
    .replace(/#{1,6}\s*/g, '')
    .replace(/[\[\]\(\)]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  const wordCount = plainText.split(/\s+/).length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return Math.max(1, Math.min(minutes, 60));
}

function getPostReadTime(post) {
  if (post.data.readTime) return post.data.readTime;
  if (post.body) return calculateReadTime(post.body);
  const estimates = {
    'getting-started': 8, 'security-privacy': 10,
    'airdrop-farming': 12, 'defi-yield': 15
  };
  return estimates[post.data.pillar] || 10;
}

// Get all posts with readTime
const allPostsRaw = await getCollection('posts', ({ data }) => !data.draft);
const allPosts = allPostsRaw.map(post => ({
  ...post,
  data: {
    ...post.data,
    readTime: getPostReadTime(post)
  }
}));

// Sort by date
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Pagination
const pageSize = 12;
const currentPage = 1; // You can add pagination logic later
const paginatedPosts = sortedPosts.slice(0, pageSize);
const totalPages = Math.ceil(allPosts.length / pageSize);

// === ADDED: Blog listing OG image ===
// Use a specific image for the blog listing page
const blogOgImage = "/images/og-txchyon.png";
---

<Base 
  title="Intel Repository // Private Research // Txchyon OS" 
  description="Explore the full repository of private DeFi research, systematic trading briefings, and institutional-grade intelligence."
  image={blogOgImage}
>
  <section class="min-h-screen dark:bg-black bg-white py-24 relative overflow-hidden">
    {/* Background Accents */}
    <div class="absolute inset-0 dark:bg-[radial-gradient(#ffffff05_1px,transparent_1px)] bg-[radial-gradient(#00000005_1px,transparent_1px)] [background-size:32px_32px]"></div>
    
    <div class="container mx-auto px-4 relative z-10">
      {/* Hero Header */}
      <div class="max-w-4xl mb-20">
        <div class="inline-flex items-center gap-3 px-3 py-1 rounded-full bg-cyan-500/10 border border-cyan-500/20 mb-8">
          <span class="w-1.5 h-1.5 rounded-full bg-cyan-500 animate-pulse"></span>
          <span class="text-[10px] font-black text-cyan-500 uppercase tracking-[0.2em]">Repository_Access_Granted</span>
        </div>
        
        <h1 class="text-5xl md:text-7xl font-black dark:text-white text-gray-900 mb-8 italic tracking-tighter uppercase">
          Protocol <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-purple-500 italic">Intel_</span>
        </h1>
        
        <p class="text-xl md:text-2xl dark:text-gray-400 text-gray-600 font-medium italic leading-relaxed max-w-2xl">
          Institutional-grade research. Systematic trading briefings. <br class="hidden md:block"/> No paywalls. Just pure alpha.
        </p>

        {/* Stats Grid */}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8 mt-12 pt-12 border-t border-gray-100 dark:border-white/5">
          <div>
            <div class="text-2xl font-black dark:text-white text-gray-900 tabular-nums italic">{allPosts.length}</div>
            <div class="text-[9px] font-black text-gray-400 dark:text-gray-600 uppercase tracking-widest">Active_Briefs</div>
          </div>
          <div>
            <div class="text-2xl font-black dark:text-white text-gray-900 tabular-nums italic">1200+</div>
            <div class="text-[9px] font-black text-gray-400 dark:text-gray-600 uppercase tracking-widest">Global_Nodes</div>
          </div>
          <div>
            <div class="text-2xl font-black text-green-500 italic tabular-nums">0 SOL_</div>
            <div class="text-[9px] font-black text-gray-400 dark:text-gray-600 uppercase tracking-widest">Access_Fee</div>
          </div>
          <div>
            <div class="text-2xl font-black dark:text-white text-gray-900 italic uppercase">Open</div>
            <div class="text-[9px] font-black text-gray-400 dark:text-gray-600 uppercase tracking-widest">Protocol_State</div>
          </div>
        </div>
      </div>

      {/* Category Filter System */}
      <div class="mb-16">
        <div class="flex items-center gap-4 mb-8">
          <span class="text-[10px] font-black text-gray-400 dark:text-gray-600 uppercase tracking-widest">Filter_Clusters:</span>
          <div class="h-px flex-1 bg-gradient-to-r from-gray-100 to-transparent dark:from-white/5 dark:to-transparent"></div>
        </div>
        
        <div class="flex flex-wrap gap-3">
          {[
            { name: 'Getting Started', slug: 'getting-started', color: 'blue' },
            { name: 'Security & Privacy', slug: 'security-privacy', color: 'red' },
            { name: 'Airdrop Farming', slug: 'airdrop-farming', color: 'yellow' },
            { name: 'DeFi Yield', slug: 'defi-yield', color: 'green' },
            { name: 'Infrastructure', slug: 'infrastructure-tech', color: 'cyan' },
            { name: 'Tools', slug: 'tools-automation', color: 'purple' }
          ].map(cat => (
            <a href={`/categories/${cat.slug}`} 
               class="group relative px-6 py-3 rounded-2xl bg-gray-50 dark:bg-zinc-900/50 border border-gray-200 dark:border-white/5 transition-all hover:-translate-y-1 hover:border-cyan-500/30 overflow-hidden">
              <span class="relative z-10 text-[11px] font-black text-gray-600 dark:text-gray-400 uppercase tracking-widest group-hover:text-cyan-500 transition-colors">
                {cat.name}
              </span>
              <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </a>
          ))}
        </div>
      </div>

      {/* Posts Grid */}
      <div class="mb-24">
        <Posts posts={paginatedPosts} className="grid-cols-1 md:grid-cols-2 lg:grid-cols-3" fluid={true} />
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <div class="mb-24">
          <Pagination currentPage={currentPage} totalPages={totalPages} section="blog" />
        </div>
      )}

      {/* Industrial Footer CTA */}
      <div class="relative p-1 bg-gradient-to-r from-cyan-500/20 to-purple-500/20 rounded-[2.5rem] max-w-3xl mx-auto overflow-hidden">
        <div class="absolute inset-0 dark:bg-[radial-gradient(#ffffff05_1px,transparent_1px)] bg-[radial-gradient(#00000005_1px,transparent_1px)] [background-size:16px_16px]"></div>
        <div class="relative dark:bg-black bg-white rounded-[2.4rem] p-12 text-center border dark:border-white/5 border-gray-100">
          <h2 class="text-3xl font-black dark:text-white text-gray-900 mb-4 uppercase italic tracking-tighter leading-none">
            Intelligence <span class="text-cyan-500 italic">Request_</span>
          </h2>
          <p class="dark:text-gray-400 text-gray-600 mb-10 font-medium italic max-w-md mx-auto leading-relaxed">
            Protocol gaps? Missing analysis? We build in public. Suggest a guide or technical briefing via our network.
          </p>
          <a href="https://twitter.com/txchyon" target="_blank" 
             class="inline-flex items-center gap-4 px-8 py-4 bg-gray-900 dark:bg-white text-white dark:text-black font-black uppercase text-xs tracking-widest rounded-2xl hover:scale-105 transition-all italic">
            <span>üê¶</span>
            Submit_Intel_Request
          </a>
        </div>
      </div>
    </div>
  </section>
</Base>
