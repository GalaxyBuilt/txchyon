---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import { plainify } from "@/lib/utils/textConverter";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import FloatingBubble from "@/components/FloatingBubble.jsx";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import { ClientRouter } from "astro:transitions";
import SEO from "@/layouts/components/SEO.astro";

const pf = theme.fonts.font_family.primary;
let fontPrimary;
if (theme.fonts.font_family.primary) {
  fontPrimary = theme.fonts.font_family.primary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;]+/gi, "");
}

const query = Astro.url.searchParams.get('q')?.trim() || '';

// Same glob + content reading
const pageModules = import.meta.glob('../pages/**/*.{astro,md,mdx}', { eager: true });
const guideModules = import.meta.glob('../../../guides/**/*.{md,mdx}', { eager: true });

const allModules = { ...pageModules, ...guideModules };

const allContent = Object.values(allModules)
  .filter(mod => mod.frontmatter?.title && mod.file)
  .map(mod => {
    let rawContent = '';
    try {
      rawContent = mod.rawContent?.() || mod.getRawContent?.() || '';
      if (!rawContent && mod.file) {
        const fileContent = Deno.readTextFileSync(mod.file);
        rawContent = fileContent || '';
      }
    } catch (e) {
      console.warn(`Could not read content for ${mod.file}`);
    }

    let url = '/';
    if (mod.url) {
      url = mod.url;
    } else if (mod.file) {
      url = mod.file
        .replace(/^.*src\/pages/, '')
        .replace(/^.*guides/, '/guides')
        .replace(/\/index\.(astro|md|mdx)$/, '/')
        .replace(/\.(astro|md|mdx)$/, '')
        .replace(/\/$/, '') || '/';
      if (!url.startsWith('/')) url = '/' + url;
    }

    return {
      title: mod.frontmatter.title || 'Untitled',
      description: mod.frontmatter.description || '',
      content: rawContent.toLowerCase(),
      url: url,
    };
  });

const results = query.length >= 2 
  ? allContent.filter(item => {
      const lowerQuery = query.toLowerCase();
      return (
        item.title.toLowerCase().includes(lowerQuery) ||
        item.description.toLowerCase().includes(lowerQuery) ||
        item.content.includes(lowerQuery)
      );
    })
  : [];

const title = query ? `Search Results for "${query}" - Txchyon` : "Search - Txchyon";
const description = query 
  ? `Search results for "${query}" across guides and documentation.`
  : "Search through all guides, tutorials, and pages on Txchyon.";

// FIXED: Add canonical logic to frontmatter
const cleanPath = Astro.url.pathname.replace(/\/$/, ""); // Remove trailing slash
const canonical = `${config.site.base_url}${cleanPath}`;
---

<!doctype html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W77T47Y58P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W77T47Y58P');
    </script>

    <link rel="shortcut icon" href={config.site.favicon} />
    <meta name="theme-name" content="bookworm-light-astro" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000" />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
      ]}
    />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <!-- FIXED: SEO component with proper props -->
    <SEO
      title={title}
      description={description}
      image={`${config.site.base_url}${config.metadata.meta_image}`}
      canonical={canonical}
    />

    <link rel="alternate" type="application/rss+xml" title="Txchyon RSS" href="/rss.xml" />
    <link rel="alternate" type="application/feed+json" title="Txchyon JSON Feed" href="/feed.json" />

    <ClientRouter />
    <meta name="author" content={config.metadata.meta_author} />
  </head>

  <body class="bg-body text-text font-primary font-normal leading-relaxed dark:bg-dark dark:text-light">
    <TwSizeIndicator />
    <Header />

    <main id="main-content" class="min-h-[60vh] py-12">
      <div class="container mx-auto px-4 max-w-4xl">
        <h1 class="text-4xl font-bold mb-8 text-center">Search Results</h1>
        
        <div class="mb-10">
          <form method="GET" action="/search-results" class="flex gap-3 max-w-2xl mx-auto">
            <input
              type="search"
              name="q"
              value={query}
              placeholder="Search guides and pages..."
              class="flex-1 p-4 text-lg border rounded-lg dark:bg-gray-800 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
              autofocus
            />
            <button
              type="submit"
              class="px-8 py-4 bg-blue-600 text-white text-lg rounded-lg hover:bg-blue-700 transition-colors"
            >
              Search
            </button>
          </form>
        </div>
        
        {query.length < 2 ? (
          <div class="text-center p-12 text-gray-500">
            <p class="text-xl">Please enter at least 2 characters to search.</p>
          </div>
        ) : results.length === 0 ? (
          <div class="text-center p-12">
            <p class="text-xl text-gray-600 dark:text-gray-300 mb-3">
              No results found for "<span class="font-semibold">{query}</span>"
            </p>
            <p class="text-gray-500">Try different keywords or check spelling.</p>
          </div>
        ) : (
          <>
            <p class="text-center text-lg text-gray-600 dark:text-gray-300 mb-8">
              Found <span class="font-semibold">{results.length}</span> {results.length === 1 ? 'result' : 'results'} for "<span class="font-semibold">{query}</span>"
            </p>
            
            <div class="space-y-8">
              {results.map(item => (
                <article class="p-8 border rounded-lg dark:bg-gray-800 dark:border-gray-700 hover:shadow-lg transition-shadow">
                  <a href={item.url} class="block group">
                    <h2 class="text-2xl font-semibold mb-3 text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400">
                      {item.title}
                    </h2>
                    {item.description && (
                      <p class="text-gray-600 dark:text-gray-300 mb-4 leading-relaxed">
                        {item.description}
                      </p>
                    )}
                    <div class="text-sm text-gray-500">
                      {item.url}
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </>
        )}
      </div>
    </main>

    <Footer />
    <FloatingBubble client:load />

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script is:global>
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
      
      document.documentElement.setAttribute('data-theme', initialTheme);
      if (initialTheme === 'dark') {
        document.documentElement.classList.add('dark');
      }
      
      if (!savedTheme) {
        localStorage.setItem('theme', initialTheme);
      }
      
      function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        const newTheme = isDark ? 'light' : 'dark';
        
        html.setAttribute('data-theme', newTheme);
        html.classList.toggle('dark');
        localStorage.setItem('theme', newTheme);
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleDarkMode);
        }
      });
      
      document.addEventListener('astro:page-load', () => {
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.replaceWith(toggleBtn.cloneNode(true));
          document.getElementById('theme-toggle')?.addEventListener('click', toggleDarkMode);
        }
      });
    </script>
  </body>
</html>
