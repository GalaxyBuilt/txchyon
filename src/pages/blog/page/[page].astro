---
import { getCollection } from 'astro:content';
import Base from "@/layouts/Base.astro";
import Posts from "@/layouts/components/Posts.astro";
import Pagination from "@/layouts/components/Pagination.astro";

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);
  const pageSize = 12;
  const totalPages = Math.ceil(allPosts.length / pageSize);

  const paths = [];
  // Start from page 2, as page 1 is /blog
  for (let page = 2; page <= totalPages; page++) {
    paths.push({
      params: { page: page.toString() },
      props: { page },
    });
  }
  return paths;
}

const { page } = Astro.props;

// Helper for readTime calculation
function calculateReadTime(content, wordsPerMinute = 130) {
  if (!content) return 10;
  const plainText = content
    .replace(/---[\s\S]*?---/, '')
    .replace(/```[\s\S]*?```/g, '')
    .replace(/<[^>]*>/g, '')
    .replace(/#{1,6}\s*/g, '')
    .replace(/[\[\]\(\)]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  const wordCount = plainText.split(/\s+/).length;
  const minutes = Math.ceil(wordCount / wordsPerMinute);
  return Math.max(1, Math.min(minutes, 60));
}

function getPostReadTime(post) {
  if (post.data.readTime) return post.data.readTime;
  if (post.body) return calculateReadTime(post.body);
  const estimates = {
    'getting-started': 8, 'security-privacy': 10,
    'airdrop-farming': 12, 'defi-yield': 15
  };
  return estimates[post.data.pillar] || 10;
}

// Get all posts with readTime
const allPostsRaw = await getCollection('posts', ({ data }) => !data.draft);
const allPosts = allPostsRaw.map(post => ({
  ...post,
  data: {
    ...post.data,
    readTime: getPostReadTime(post)
  }
}));

// Sort by date
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Pagination logic
const pageSize = 12;
const currentPage = Number(page);
const paginatedPosts = sortedPosts.slice((currentPage - 1) * pageSize, currentPage * pageSize);
const totalPages = Math.ceil(allPosts.length / pageSize);

const blogOgImage = "/images/og-txchyon.png";
---

<Base 
  title={`Intel Repository // Page ${currentPage} // Txchyon OS`} 
  description={`Explore more DeFi research and systematic trading briefings on page ${currentPage} of the Txchyon Research Hub.`}
  image={blogOgImage}
>
  <section class="min-h-screen dark:bg-black bg-white py-24 relative overflow-hidden">
    <div class="absolute inset-0 dark:bg-[radial-gradient(#ffffff05_1px,transparent_1px)] bg-[radial-gradient(#00000005_1px,transparent_1px)] [background-size:32px_32px]"></div>
    
    <div class="container mx-auto px-4 relative z-10">
      <div class="max-w-4xl mb-20">
        <h1 class="text-5xl md:text-7xl font-black dark:text-white text-gray-900 mb-8 italic tracking-tighter uppercase">
          Protocol <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-purple-500 italic">Intel_</span>
          <span class="text-2xl align-top ml-4 text-gray-400">PAGE_{currentPage}</span>
        </h1>
      </div>

      <div class="mb-24">
        <Posts posts={paginatedPosts} className="grid-cols-1 md:grid-cols-2 lg:grid-cols-3" fluid={true} />
      </div>

      <div class="mb-24">
        <Pagination currentPage={currentPage} totalPages={totalPages} section="blog" />
      </div>
    </div>
  </section>
</Base>
