---
import TwSizeIndicator from "@/components/TwSizeIndicator.astro";
import config from "@/config/config.json";
import theme from "@/config/theme.json";
import Footer from "@/partials/Footer.astro";
import Header from "@/partials/Header.astro";
import FloatingBubble from "@/components/FloatingBubble.jsx";
import "@/styles/main.css";
import { AstroFont } from "astro-font";
import { ClientRouter } from "astro:transitions";
import SEO from "@/layouts/components/SEO.astro";

const pf = theme.fonts.font_family.primary;
let fontPrimary;
if (theme.fonts.font_family.primary) {
  fontPrimary = theme.fonts.font_family.primary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;]+/gi, "");
}

export interface Props {
  title?: string;
  meta_title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  canonical?: string;
  // NEW: Add these optional props for gating flexibility
  isFullyGated?: boolean;      // For completely gated articles
  hasGatedContent?: boolean;   // For partially gated articles
}

const { 
  title, 
  meta_title, 
  description, 
  image, 
  noindex, 
  canonical,
  isFullyGated = false,
  hasGatedContent = false 
} = Astro.props;

const escapeHtml = (text) => {
  if (!text) return '';
  
  let processed = text.toString()
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#039;/g, "'")
    .replace(/&nbsp;/g, ' ');
  
  return processed
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;')
    .trim();
};

const finalTitle = escapeHtml(meta_title ?? title ?? config.site.title);
const finalDescription = escapeHtml(description ?? config.metadata.meta_description);

const finalImage = image && typeof image === 'string' && image.trim()
  ? `${config.site.base_url}${image.startsWith("/") ? "" : "/"}${image}`
  : `${config.site.base_url}${config.metadata.meta_image}`;

const cleanPath = Astro.url.pathname.replace(/\/$/, "");
const finalCanonical = canonical ?? `${config.site.base_url}${cleanPath}`;
---
<!doctype html>
<html lang="en">
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W77T47Y58P"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-W77T47Y58P');
    </script>

    <script src="https://analytics.ahrefs.com/analytics.js" data-key="BM9NrhHESqRca7xP0Vuqeg" async></script>

    <link rel="shortcut icon" href={config.site.favicon} />
    <meta name="theme-name" content="bookworm-light-astro" />
    <meta name="msapplication-TileColor" content="#000000" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="generator" content={Astro.generator} />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
      ]}
    />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

    <SEO
      title={finalTitle}
      description={finalDescription}
      image={finalImage}
      canonical={finalCanonical}
      noindex={!!noindex}
      type="website"
    />

    <!-- FLEXIBLE SCHEMA: Choose your gating strategy per article -->
    {title && (
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "BlogPosting",
          "headline": "{finalTitle}",
          "description": "{finalDescription}",
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "{Astro.url.origin}{Astro.url.pathname}"
          }
          {isFullyGated ? `,
          "isAccessibleForFree": "false",
          "publisher": {
            "@type": "Organization",
            "name": "Txchyon",
            "logo": {
              "@type": "ImageObject",
              "url": "https://yourdomain.com/logo.png"
            }
          }` : hasGatedContent ? `,
          "isAccessibleForFree": "true",
          "hasPart": {
            "@type": "WebPageElement",
            "isAccessibleForFree": "false",
            "cssSelector": ".locked-content",
            "name": "Premium Content",
            "description": "Step-by-step technical instructions requiring newsletter subscription"
          }` : `,
          "isAccessibleForFree": "true"`}
        }
      </script>
    )}

    <link rel="alternate" type="application/rss+xml" title="Txchyon RSS" href="/rss.xml" />
    <link rel="alternate" type="application/feed+json" title="Txchyon JSON Feed" href="/feed.json" />

    <ClientRouter />
    <meta name="author" content={config.metadata.meta_author} />
    
    <!-- SIMPLE, RELIABLE THEME SCRIPT -->
    <script>
      // Check for saved theme or use system preference
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        // Apply theme immediately to prevent flash
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
          document.documentElement.setAttribute('data-theme', 'dark');
          // Update theme-color meta tag
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#000000');
        } else {
          document.documentElement.classList.remove('dark');
          document.documentElement.setAttribute('data-theme', 'light');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#ffffff');
        }
        
        // Save default theme if not set
        if (!savedTheme) {
          localStorage.setItem('theme', prefersDark ? 'dark' : 'light');
        }
      })();
    </script>
    
    <style>
      * {
        transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
      }
    </style>
  </head>

  <body class="bg-body text-text font-primary font-normal leading-relaxed dark:bg-dark dark:text-light">
    <TwSizeIndicator />
    <Header />
    <main id="main-content" class="min-h-[60vh]">
      <slot />
    </main>
    <Footer />

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <FloatingBubble client:load />
  
    <!-- Theme toggle functionality -->
    <script>
      // Toggle function
      function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        const newTheme = isDark ? 'light' : 'dark';
        
        if (newTheme === 'dark') {
          html.classList.add('dark');
          html.setAttribute('data-theme', 'dark');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#000000');
        } else {
          html.classList.remove('dark');
          html.setAttribute('data-theme', 'light');
          document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#ffffff');
        }
        
        localStorage.setItem('theme', newTheme);
        
        // Update theme icons
        updateThemeIcons();
      }
      
      // Update theme icons
      function updateThemeIcons() {
        const sunIcon = document.getElementById('theme-icon-sun');
        const moonIcon = document.getElementById('theme-icon-moon');
        const isDark = document.documentElement.classList.contains('dark');
        
        if (sunIcon) sunIcon.classList.toggle('hidden', isDark);
        if (moonIcon) moonIcon.classList.toggle('hidden', !isDark);
      }
      
      // Attach click handler
      document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleDarkMode);
        }
        
        // Initialize icons
        updateThemeIcons();
      });
      
      // Re-attach on page navigation
      document.addEventListener('astro:page-load', () => {
        const toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleDarkMode);
        }
        
        // Update icons
        updateThemeIcons();
      });
    </script>
  </body>
</html>