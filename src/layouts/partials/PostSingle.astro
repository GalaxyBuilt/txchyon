---
import SocialShare from "@/components/SocialShare.astro";
import SimilarPosts from "@/components/SimilarPosts.astro";
import SEO from "@/layouts/components/SEO.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similerItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import { render } from "astro:content";
import { BiCalendarEdit, BiCategoryAlt } from "react-icons/bi";

const allAuthors = await getSinglePage("authors");
const posts = await getSinglePage("posts");
const { post } = Astro.props;

const similarPosts = similerItems(post, posts, post.slug);
const { Content } = await render(post);
const { title, description, authors, categories, image, date, tags } = post.data;

const siteUrl = "https://txchyon.com";
const canonicalUrl = `${siteUrl}${Astro.url.pathname}`;
const ogImage = image ? `${siteUrl}${image}` : `${siteUrl}/og-default.jpg`;

// Safe author handling
const getAuthorNames = () => {
  if (!authors || !Array.isArray(authors)) return "NefuTrades";
  
  const names = authors
    .map(a => a?.data?.name)
    .filter(name => name && typeof name === 'string');
  
  return names.length > 0 ? names.join(", ") : "NefuTrades";
};

const authorNames = getAuthorNames();
---

<!-- Add SEO component for social cards -->
<SEO 
  title={`${title} | Txchyon`}
  description={description}
  image={image || "/images/tokens.jpg"}
  canonical={canonicalUrl}
  type="article"
  publishedTime={date.toISOString()}
  author={authorNames}
  section={categories?.[0] || "DeFi"}
/>

<!-- Keep existing viewport meta -->
<meta name="viewport" content="width=device-width, initial-scale=1" />

<section class="section">
  <div class="container">
    <article class="row justify-center">
      <!-- Title + meta info (unchanged) -->
      <div class="md:col-10 text-center">
        <h1 set:html={markdownify(title)} class="h2" />
        <ul class="mt-4 flex flex-wrap items-center justify-center text-text">
          <!-- Author, Date, Categories – with safe handling -->
          {authorNames !== "NefuTrades" && (
            <li class="mr-4 flex items-center">
              {authorNames.split(", ").map((name: string, i: number) => (
                <span>
                  {i > 0 && ", "}
                  <a
                    href={`/authors/${slugify(name)}`}
                    class="ml-1 hover:text-primary"
                  >
                    {name}
                  </a>
                </span>
              ))}
            </li>
          )}
          <li class="mr-4 flex items-center">
            <BiCalendarEdit class="mr-1" />
            {dateFormat(date)}
          </li>
          {categories && (
            <li class="flex items-center">
              <BiCategoryAlt class="mr-1" />
              {categories.map((category: string, i: number) => (
                <span>
                  {i > 0 && ", "}
                  <a
                    href={`/categories/${slugify(category)}`}
                    class="ml-1 hover:text-primary"
                  >
                    {humanize(category)}
                  </a>
                </span>
              ))}
            </li>
          )}
        </ul>
      </div>

      <!-- Featured image (unchanged) -->
      {image && (
        <div class="col-12 mt-8 mb-2">
          <Image src={image} height={500} width={1000} alt={title} class="rounded-lg w-full" />
        </div>
      )}

      <!-- Main content -->
      <div class="md:col-10">
        <div class="content mb-16 text-left">
          <Content />
        </div>

        <!-- MOBILE-OPTIMIZED BEEHIIV FORM WITH PLAIN CSS -->
        <!-- Updated: 2024-12-08 for mobile responsiveness -->
        <div class="my-16 md:my-20 px-4 sm:px-6 lg:px-8">
          <div class="mx-auto max-w-2xl rounded-2xl border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 p-6 sm:p-8 lg:p-10 text-center shadow-lg">
            
            <!-- SIMPLE CSS VERSION - Bypasses Tailwind -->
            <h3 class="desktop-title">Get Weekly DeFi Alpha in Your Inbox</h3>
            <h3 class="mobile-title">Weekly DeFi Alpha</h3>
            
            <p class="desktop-desc">56k+ traders getting my private newsletter every week</p>
            <p class="mobile-desc">Join To Download our Ebook Free</p>

            <style>
              /* Mobile first */
              .desktop-title, .desktop-desc {
                display: none;
              }
              
              .mobile-title, .mobile-desc {
                display: block;
              }
              
              .mobile-title, .desktop-title {
                font-size: 1.5rem; /* text-2xl */
                font-weight: 700; /* font-bold */
                margin-bottom: 0.75rem; /* mb-3 */
                line-height: 1.25; /* leading-tight */
              }
              
              .mobile-desc, .desktop-desc {
                font-size: 1rem; /* text-base */
                color: #4b5563; /* text-gray-600 */
                margin-bottom: 2rem; /* mb-8 */
                max-width: 36rem; /* max-w-xl */
                margin-left: auto;
                margin-right: auto;
                line-height: 1.625; /* leading-relaxed */
              }
              
              .dark .mobile-desc, .dark .desktop-desc {
                color: #9ca3af; /* dark:text-gray-400 */
              }
              
              /* Desktop styles */
              @media (min-width: 640px) {
                .desktop-title, .desktop-desc {
                  display: block !important;
                }
                .mobile-title, .mobile-desc {
                  display: none !important;
                }
                
                .desktop-title {
                  font-size: 1.875rem; /* text-3xl */
                  margin-bottom: 1rem; /* mb-4 */
                }
                
                .desktop-desc {
                  font-size: 1.125rem; /* text-lg */
                  margin-bottom: 2.5rem; /* sm:mb-10 */
                }
              }
            </style>

            <!-- FIXED: Wider Beehiiv iframe (500px) for proper email field -->
            <div class="w-full flex justify-center">
              <script async src="https://subscribe-forms.beehiiv.com/embed.js"></script>
              <iframe
                src="https://subscribe-forms.beehiiv.com/cc63cad9-7786-4f32-badd-628ad1226266"
                class="beehiiv-embed"
                data-test-id="beehiiv-embed"
                frameborder="0"
                scrolling="no"
                style="width: 500px; height: 420px; border: none; border-radius: 12px; max-width: 100%;"
                loading="lazy"
              ></iframe>
            </div>

            <noscript>
              <p class="text-sm text-gray-500 mt-4">
                <a href="https://txchyon.beehiiv.com/subscribe" target="_blank" rel="noopener" class="underline hover:text-primary">
                  Subscribe to the newsletter
                </a>
              </p>
            </noscript>
          </div>
        </div>

        <!-- Tags and Share Buttons -->
        <div class="my-20 text-center border-t-2 border-gray-200 dark:border-gray-700 pt-12">
          <!-- Tags -->
          <div class="flex flex-wrap justify-center gap-3 mb-12">
            {tags?.map((tag: string) => (
              <a href={`/tags/${slugify(tag)}`} class="px-5 py-2 bg-gray-100 dark:bg-gray-800 rounded-full text-sm font-medium hover:text-primary">
                #{humanize(tag)}
              </a>
            ))}
          </div>

          <!-- SHARE BUTTONS – NOW VISIBLE -->
          <SocialShare title={title} url={Astro.url} />
        </div>
      </div>
    </article>
  </div>
</section>

<!-- Similar posts – untouched -->
{similarPosts.length > 0 && (
  <section class="section pt-0">
    <div class="container">
      <h2 class="mb-8 text-center h3">Similar Posts</h2>
      <SimilarPosts posts={similarPosts.slice(0, 3)} />
    </div>
  </section>
)}