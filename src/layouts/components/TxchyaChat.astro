---
/**
 * TxchyaChat.astro
 * Floating cyberpunk AI assistant widget.
 */
---

<div id="txchya-wrapper" class="fixed bottom-6 right-6 z-[9999] font-primary">
  <!-- Chat Bubble -->
  <button 
    id="txchya-bubble" 
    class="relative w-16 h-16 rounded-full bg-black border-2 border-[#00f3ff] shadow-[0_0_20px_rgba(0,243,255,0.4)] flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110 active:scale-95 group overflow-hidden"
    aria-label="Talk to Txchya"
  >
    <div class="absolute inset-0 bg-gradient-to-tr from-[#00f3ff22] to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
    <!-- Mini Galaxy Icon / Avatar -->
    <span class="text-2xl group-hover:rotate-12 transition-transform">ðŸŒŒ</span>
    
    <!-- Pulse Effect -->
    <div class="absolute inset-0 rounded-full border-2 border-[#00f3ff] animate-ping opacity-20"></div>
  </button>

  <!-- Chat Window -->
  <div 
    id="txchya-window" 
    class="absolute bottom-20 right-0 w-[350px] sm:w-[400px] h-[500px] bg-[#0a0a0a]/90 backdrop-blur-xl border border-[#00f3ff44] rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col transition-all duration-500 transform translate-y-10 opacity-0 pointer-events-none"
  >
    <!-- Header -->
    <div class="p-4 border-b border-[#ffffff11] bg-gradient-to-r from-[#00f3ff11] to-transparent flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-black border border-[#00f3ff] flex items-center justify-center text-xs">ðŸŒŒ</div>
        <div>
          <h3 class="text-[#00f3ff] font-bold text-sm tracking-widest uppercase">Txchya OS</h3>
          <div class="flex items-center gap-1.5">
            <span class="w-1.5 h-1.5 rounded-full bg-[#00f3ff] animate-pulse"></span>
            <span class="text-[10px] text-[#00f3ff]/60 uppercase tracking-tighter">Systems Online</span>
          </div>
        </div>
      </div>
      <button id="txchya-close" class="text-white/40 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <!-- Chat Messages -->
    <div id="txchya-messages" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth">
      <div class="flex flex-col items-start max-w-[85%]">
        <div class="bg-[#111] border border-[#00f3ff22] text-[#00f3ff] px-4 py-2 rounded-2xl rounded-tl-none text-sm">
          <b>Txchya:</b> Booting up... Systems online. How can I assist you in the ecosystem today?
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-top border-[#ffffff11] bg-black">
      <div class="relative">
        <input 
          type="text" 
          id="txchya-input" 
          placeholder="Type a message..." 
          class="w-full bg-[#111] border border-[#333] text-white text-sm px-4 py-3 pr-12 rounded-xl focus:outline-none focus:border-[#00f3ff] transition-all"
        />
        <button 
          id="txchya-send" 
          class="absolute right-2 top-1/2 -translate-y-1/2 text-[#00f3ff] hover:scale-110 transition-transform disabled:opacity-50"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  #txchya-messages::-webkit-scrollbar {
    width: 4px;
  }
  #txchya-messages::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 10px;
  }
  #txchya-messages::-webkit-scrollbar-thumb:hover {
    background: #00f3ff44;
  }

  /* Chat window visibility */
  #txchya-window.open {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  .user-bubble {
    background: #222;
    color: #eee;
    border: 1px solid #444;
  }

  .txchya-bubble {
    background: linear-gradient(135deg, #0d0d0d 0%, #1a1a1a 100%);
    color: #00f3ff;
    border: 1px solid #00f3ff44;
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.05);
  }
</style>

<script>
  const BACKEND_URL = 'http://localhost:3000/chat'; // Update to production URL when available

  const bubble = document.getElementById('txchya-bubble');
  const window_el = document.getElementById('txchya-window');
  const closeBtn = document.getElementById('txchya-close');
  const input = document.getElementById('txchya-input');
  const sendBtn = document.getElementById('txchya-send');
  const messagesBox = document.getElementById('txchya-messages');

  function toggleChat() {
    window_el.classList.toggle('open');
    if (window_el.classList.contains('open')) {
      input.focus();
    }
  }

  bubble.addEventListener('click', toggleChat);
  closeBtn.addEventListener('click', () => window_el.classList.remove('open'));

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    appendMessage('You', text, 'user-bubble', 'end');
    input.value = '';
    
    // Typing indicator
    const loadingId = appendMessage('Txchya', '...', 'txchya-bubble', 'start');

    try {
      const response = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          message: text,
          site: window.location.hostname
        })
      });
      
      const data = await response.json();
      if (data.reply) {
        updateMessage(loadingId, data.reply);
      } else {
        updateMessage(loadingId, data.error || 'The neural link is flickering. Systems unstable.');
      }
    } catch (err) {
      updateMessage(loadingId, 'Connection link unstable. Please retry, Operator.');
    }
  }

  function appendMessage(sender, text, classes, align) {
    const id = 'txchya-msg-' + Date.now();
    const wrapper = document.createElement('div');
    wrapper.className = `flex flex-col items-${align === 'end' ? 'end' : 'start'} w-full`;
    
    wrapper.innerHTML = `
      <div id="${id}" class="${classes} max-w-[85%] px-4 py-2 rounded-2xl ${align === 'end' ? 'rounded-tr-none' : 'rounded-tl-none'} text-sm leading-relaxed">
        <b>${sender}:</b> ${text}
      </div>
    `;
    
    messagesBox.appendChild(wrapper);
    messagesBox.scrollTop = messagesBox.scrollHeight;
    return id;
  }

  function updateMessage(id, text) {
    const el = document.getElementById(id);
    if (el) {
      el.innerHTML = `<b>Txchya:</b> ${text}`;
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
</script>
